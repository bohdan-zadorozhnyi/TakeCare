{% extends 'base.html' %}
{% load static %}

{% block title %}Calendar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<style>
    .calendar-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        height: calc(100vh - 140px);
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .calendar-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
    }
    
    .calendar-controls {
        display: flex;
        gap: 10px;
    }
    
    .calendar-filter {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .settings-btn {
        margin-left: 10px;
    }
    
    #calendar {
        height: calc(100% - 60px);
    }
    
    .fc-event {
        cursor: pointer;
    }
    
    .fc-event-title {
        font-weight: 500;
    }
    
    .fc-event-time {
        font-weight: normal;
        font-size: 0.85em;
    }

    .settings-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .settings-modal.active {
        display: flex;
    }
    
    .settings-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-header h2 {
        margin: 0;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .calendar-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .calendar-controls {
            flex-wrap: wrap;
        }
        
        .calendar-container {
            padding: 10px;
            height: calc(100vh - 120px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h1 class="calendar-title">My Calendar</h1>
        
        <div class="calendar-controls">
            <div class="calendar-filter">
                <select id="view-selector" class="form-select">
                    <option value="dayGridMonth" {% if default_view == 'month' %}selected{% endif %}>Month</option>
                    <option value="timeGridWeek" {% if default_view == 'week' %}selected{% endif %}>Week</option>
                    <option value="timeGridDay" {% if default_view == 'day' %}selected{% endif %}>Day</option>
                </select>
                
                {% if user_role == "DOCTOR" %}
                <button id="add-slot-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Slot
                </button>
                {% endif %}
            </div>
            
            <button id="settings-btn" class="btn btn-outline-secondary settings-btn">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>
    
    <div id="calendar"></div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="settings-modal">
    <div class="settings-content">
        <div class="modal-header">
            <h2>Calendar Settings</h2>
            <button id="close-settings" class="close-btn">&times;</button>
        </div>
        
        <form id="settings-form" action="{% url 'update_calendar_settings' %}" method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="default_view">Default View</label>
                <select id="default_view" name="default_view" class="form-control">
                    <option value="month" {% if default_view == 'month' %}selected{% endif %}>Month</option>
                    <option value="week" {% if default_view == 'week' %}selected{% endif %}>Week</option>
                    <option value="day" {% if default_view == 'day' %}selected{% endif %}>Day</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reminder_before">Reminder Before Appointment (hours)</label>
                <select id="reminder_before" name="reminder_before" class="form-control">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="3">3 hours</option>
                    <option value="6">6 hours</option>
                    <option value="12">12 hours</option>
                    <option value="24">24 hours</option>
                    <option value="48">48 hours</option>
                </select>
            </div>
            
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="show_past_appointments" name="show_past_appointments" checked>
                <label class="form-check-label" for="show_past_appointments">Show past appointments</label>
            </div>
            
            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the calendar element
        const calendarEl = document.getElementById('calendar');
        
        // Get the view selector
        const viewSelector = document.getElementById('view-selector');
        
        // Initialize the calendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: viewSelector.value,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            events: '{% url "get_appointments_json" %}',
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                meridiem: 'short'
            },
            height: '100%',
            expandRows: true,
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            nowIndicator: true,
            navLinks: true,
            businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5],  // Monday - Friday
                startTime: '08:00',
                endTime: '18:00',
            },
            eventClick: function(info) {
                window.location.href = info.event.url;
            },
            loading: function(isLoading) {
                if (isLoading) {
                    // Show loading indicator
                    console.log('Loading events...');
                } else {
                    // Hide loading indicator
                    console.log('Events loaded.');
                }
            }
        });
        
        // Initialize the calendar
        calendar.render();
        
        // Handle view change
        viewSelector.addEventListener('change', function() {
            calendar.changeView(this.value);
        });
        
        // Settings modal handling
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettings = document.getElementById('close-settings');
        
        settingsBtn.addEventListener('click', function() {
            settingsModal.classList.add('active');
        });
        
        closeSettings.addEventListener('click', function() {
            settingsModal.classList.remove('active');
        });
        
        // Close modal when clicking outside
        settingsModal.addEventListener('click', function(e) {
            if (e.target === this) {
                settingsModal.classList.remove('active');
            }
        });
        
        {% if user_role == "DOCTOR" %}
        // Handle add slot button for doctors
        const addSlotBtn = document.getElementById('add-slot-btn');
        
        addSlotBtn.addEventListener('click', function() {
            // For now, just show an alert that this feature is coming soon
            alert('Create appointment slot feature is coming soon!');
            // Will be replaced with: window.location.href = '{% url "appointment" %}';
        });
        {% endif %}
    });
</script>
{% endblock %}