{% extends 'base.html' %}
{% load static %}

{% block title %}My Referrals{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .referral-card {
        transition: transform 0.3s;
    }
    .referral-card:hover {
        transform: translateY(-5px);
    }
    .badge-specialist {
        background-color: #6f42c1;
        color: white;
    }
    .badge-expires {
        background-color: #fd7e14;
        color: white;
    }
    .badge-used {
        background-color: #6c757d;
        color: white;
    }
    .badge-expired {
        background-color: #dc3545;
        color: white;
    }
    .badge-active {
        background-color: #28a745;
        color: white;
    }
    .filter-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .priority-high {
        color: #dc3545;
    }
    .priority-medium {
        color: #fd7e14;
    }
    .priority-low {
        color: #28a745;
    }
    .priority-urgent {
        color: #dc3545;
        font-weight: bold;
    }
    .filter-spacing {
        margin-right: 2.5rem;  /* Increased spacing between filter switches */
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">My Referrals</h2>
        {% if user.role == 'DOCTOR' %}
        <a href="{% url 'referrals:create_referral' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Create New Referral
        </a>
        {% endif %}
    </div>
    
    <div class="card filter-card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex">
                        <div class="custom-control custom-switch filter-spacing">
                            <input type="checkbox" class="custom-control-input" id="filter-active" 
                                   {% if filters.active %}checked{% endif %}>
                            <label class="custom-control-label" for="filter-active">Active</label>
                        </div>
                        <div class="custom-control custom-switch filter-spacing">
                            <input type="checkbox" class="custom-control-input" id="filter-expired" 
                                   {% if filters.expired %}checked{% endif %}>
                            <label class="custom-control-label" for="filter-expired">Expired</label>
                        </div>
                        <div class="custom-control custom-switch filter-spacing">
                            <input type="checkbox" class="custom-control-input" id="filter-used" 
                                   {% if filters.used %}checked{% endif %}>
                            <label class="custom-control-label" for="filter-used">Used</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="user-search" class="form-control" style="width: 100%;">
                        {% if filters.search_name %}
                        <option value="{{ filters.search }}" selected>{{ filters.search_name }}</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        {% if referrals %}
            {% for referral in referrals %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm referral-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge badge-specialist">{{ referral.get_specialist_type_display }}</span>
                        {% if referral.is_used %}
                            <span class="badge badge-used">Used</span>
                        {% elif referral.expiration_date < today %}
                            <span class="badge badge-expired">Expired</span>
                        {% else %}
                            <span class="badge badge-active">Active</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {% if user.role == 'DOCTOR' %}
                                <p class="mb-1"><strong>Patient:</strong> {{ referral.patient.name }}</p>
                            {% else %}
                                <p class="mb-1"><strong>Doctor:</strong> {{ referral.issuing_doctor.name }}</p>
                            {% endif %}
                            <p class="mb-1"><small class="text-muted">Issued on: {{ referral.issue_date }}</small></p>
                            <p class="mb-0"><small class="text-muted">Expires on: {{ referral.expiration_date }}</small></p>
                        </div>
                        
                        <div class="mb-2">
                            <h6>Details:</h6>
                            <ul class="list-unstyled">
                                {% for detail in referral.details.all %}
                                <li>
                                    <span class="priority-{{ detail.priority|lower }}">
                                        [{{ detail.get_priority_display }}]
                                    </span> 
                                    {{ detail.diagnosis }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                        <small class="text-muted">ID: {{ referral.id|truncatechars:8 }}</small>
                        <a href="{% url 'referrals:referral_detail' referral.id %}" class="btn btn-sm btn-outline-primary">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center" role="alert">
                    <h5 class="mb-0">No referrals found</h5>
                    <p class="mb-0">
                        {% if user.role == 'DOCTOR' %}
                            <a href="{% url 'referrals:create_referral' %}" class="alert-link">Create a new referral</a> for your patients.
                        {% else %}
                            No referrals have been issued to you yet.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for user search
        $('#user-search').select2({
            ajax: {
                url: '{% url "referrals:search_users" %}',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        term: params.term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            placeholder: '{% if user.role == "DOCTOR" %}Search patients...{% else %}Search doctors...{% endif %}',
            allowClear: true // Allow clearing the selection with the "x" button
        });
        
        // Handle filter changes
        function applyFilters() {
            const activeFilter = $('#filter-active').is(':checked') ? 'true' : 'false';
            const expiredFilter = $('#filter-expired').is(':checked') ? 'true' : 'false';
            const usedFilter = $('#filter-used').is(':checked') ? 'true' : 'false';
            const searchId = $('#user-search').val();
            
            let url = '{% url "referrals:referral_list" %}?active=' + activeFilter + 
                      '&expired=' + expiredFilter + '&used=' + usedFilter;
            
            if (searchId) {
                url += '&search=' + searchId;
            }
            
            window.location.href = url;
        }
        
        $('.custom-switch input').on('change', applyFilters);
        $('#user-search').on('change', applyFilters);
    });
</script>
{% endblock %}