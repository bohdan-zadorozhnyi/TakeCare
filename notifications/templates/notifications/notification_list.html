{% extends "base.html" %}
{% load static %}

{% block title %}Notifications | TakeCare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/notifications.css' %}">
{% endblock %}

{% block content %}
<div class="container notifications-container my-4">
    <h2 class="mb-4">Your Notifications</h2>
    
    <div class="notification-filters">
        <div class="notification-search">
            <input type="text" class="form-control" id="notification-search" placeholder="Search notifications...">
        </div>
        
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Filter by Type
            </button>
            <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                <li><a class="dropdown-item filter-type active" data-type="ALL" href="#">All Types</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item filter-type" data-type="APPOINTMENT" href="#">Appointments</a></li>
                <li><a class="dropdown-item filter-type" data-type="PRESCRIPTION" href="#">Prescriptions</a></li>
                <li><a class="dropdown-item filter-type" data-type="REFERRAL" href="#">Referrals</a></li>
                <li><a class="dropdown-item filter-type" data-type="MEDICAL" href="#">Medical</a></li>
                <li><a class="dropdown-item filter-type" data-type="SYSTEM" href="#">System</a></li>
            </ul>
        </div>
        
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Filter by Status
            </button>
            <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                <li><a class="dropdown-item filter-status active" data-status="ALL" href="#">All Statuses</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item filter-status" data-status="UNREAD" href="#">Unread</a></li>
                <li><a class="dropdown-item filter-status" data-status="READ" href="#">Read</a></li>
            </ul>
        </div>
        
        <button class="btn btn-primary ms-auto" id="mark-all-read">Mark All as Read</button>
    </div>
    
    <div class="notification-list mt-4">
        <!-- Notifications will be loaded here -->
        <div class="text-center py-5" id="notifications-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    
    <div class="d-none" id="no-notifications">
        <div class="text-center p-5 border rounded">
            <i class="fas fa-bell fa-3x text-muted mb-3"></i>
            <h4>No notifications found</h4>
            <p class="text-muted">You don't have any notifications matching your filters.</p>
        </div>
    </div>
    
    <nav aria-label="Notification pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be generated here -->
        </ul>
    </nav>
</div>

<!-- Notification card template -->
<script id="notification-template" type="text/template">
    <div class="card notification-card ${status === 'UNREAD' ? 'unread' : ''}" data-id="${id}">
        <div class="notification-card-header">
            <span class="notification-card-type">${typeLabel}</span>
            <span class="notification-card-date">${formattedDate}</span>
        </div>
        <div class="notification-card-body">
            <p class="notification-card-message">${message}</p>
        </div>
        <div class="notification-card-actions">
            <button class="btn btn-sm btn-outline-secondary btn-mark-read" ${status === 'READ' ? 'disabled' : ''}>
                ${status === 'READ' ? 'Read' : 'Mark as Read'}
            </button>
            <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button>
        </div>
    </div>
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const notificationList = document.querySelector('.notification-list');
        const notificationsLoading = document.getElementById('notifications-loading');
        const noNotifications = document.getElementById('no-notifications');
        const markAllReadBtn = document.getElementById('mark-all-read');
        const searchInput = document.getElementById('notification-search');
        const notificationTemplate = document.getElementById('notification-template').innerHTML;
        const pagination = document.getElementById('pagination');
        
        // Filter variables
        let currentPage = 1;
        let typeFilter = 'ALL';
        let statusFilter = 'ALL';
        let searchQuery = '';
        
        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
        
        function getTypeLabel(type) {
            const labels = {
                'SYSTEM': 'System',
                'APPOINTMENT': 'Appointment',
                'PRESCRIPTION': 'Prescription',
                'REFERRAL': 'Referral',
                'MEDICAL': 'Medical'
            };
            return labels[type] || type;
        }
        
        // Fetch and display notifications
        function fetchNotifications() {
            notificationsLoading.style.display = 'block';
            notificationList.innerHTML = '';
            noNotifications.classList.add('d-none');
            
            let url = `/api/v1/notifications/?page=${currentPage}`;
            
            if (typeFilter !== 'ALL') {
                url += `&type=${typeFilter}`;
            }
            
            if (statusFilter !== 'ALL') {
                url += `&status=${statusFilter}`;
            }
            
            if (searchQuery) {
                url += `&search=${encodeURIComponent(searchQuery)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    notificationsLoading.style.display = 'none';
                    
                    if (!data.results || data.results.length === 0) {
                        noNotifications.classList.remove('d-none');
                        return;
                    }
                    
                    // Display notifications
                    data.results.forEach(notification => {
                        const rendered = notificationTemplate
                            .replace(/\${id}/g, notification.id)
                            .replace(/\${status === 'UNREAD' \? 'unread' : ''}/g, notification.status === 'UNREAD' ? 'unread' : '')
                            .replace(/\${typeLabel}/g, getTypeLabel(notification.type))
                            .replace(/\${formattedDate}/g, formatDate(notification.date))
                            .replace(/\${message}/g, notification.message)
                            .replace(/\${status === 'READ' \? 'disabled' : ''}/g, notification.status === 'READ' ? 'disabled' : '')
                            .replace(/\${status === 'READ' \? 'Read' : 'Mark as Read'}/g, notification.status === 'READ' ? 'Read' : 'Mark as Read');
                        
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = rendered;
                        const card = tempDiv.firstElementChild;
                        
                        // Add event listeners
                        card.querySelector('.btn-mark-read').addEventListener('click', function(e) {
                            e.stopPropagation();
                            markAsRead(notification.id);
                        });
                        
                        card.querySelector('.btn-delete').addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteNotification(notification.id);
                        });
                        
                        card.addEventListener('click', function() {
                            // Mark as read when clicked
                            if (notification.status === 'UNREAD') {
                                markAsRead(notification.id);
                            }
                            
                            // Navigate to related object if exists
                            if (notification.related_object_type && notification.related_object_id) {
                                navigateToObject(notification.related_object_type, notification.related_object_id);
                            }
                        });
                        
                        notificationList.appendChild(card);
                    });
                    
                    // Update pagination
                    updatePagination(data);
                })
                .catch(error => {
                    console.error('Error fetching notifications:', error);
                    notificationsLoading.style.display = 'none';
                    notificationList.innerHTML = `
                        <div class="alert alert-danger">
                            Error loading notifications. Please try again later.
                        </div>
                    `;
                });
        }
        
        function updatePagination(data) {
            pagination.innerHTML = '';
            
            if (!data.count || data.count <= 10) {
                return;
            }
            
            const pageCount = Math.ceil(data.count / 10);
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            prevLi.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    fetchNotifications();
                }
            });
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= pageCount; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    fetchNotifications();
                });
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            nextLi.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < pageCount) {
                    currentPage++;
                    fetchNotifications();
                }
            });
            pagination.appendChild(nextLi);
        }
        
        function markAsRead(notificationId) {
            fetch(`/api/v1/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const card = document.querySelector(`.notification-card[data-id="${notificationId}"]`);
                    card.classList.remove('unread');
                    const button = card.querySelector('.btn-mark-read');
                    button.disabled = true;
                    button.textContent = 'Read';
                }
            })
            .catch(error => console.error('Error marking as read:', error));
        }
        
        function deleteNotification(notificationId) {
            if (!confirm('Are you sure you want to delete this notification?')) {
                return;
            }
            
            fetch(`/api/v1/notifications/${notificationId}/mark-deleted/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const card = document.querySelector(`.notification-card[data-id="${notificationId}"]`);
                    card.remove();
                    
                    // Check if we need to show no notifications message
                    if (notificationList.children.length === 0) {
                        noNotifications.classList.remove('d-none');
                    }
                }
            })
            .catch(error => console.error('Error deleting notification:', error));
        }
        
        function navigateToObject(type, id) {
            let url;
            switch (type) {
                case 'appointment':
                    url = `/appointments/detail/${id}/`;
                    break;
                case 'prescription':
                    url = `/prescriptions/detail/${id}/`;
                    break;
                case 'referral':
                    url = `/referrals/detail/${id}/`;
                    break;
                default:
                    return;
            }
            
            window.location.href = url;
        }
        
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
        
        // Event listeners
        markAllReadBtn.addEventListener('click', function() {
            fetch('/api/v1/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    document.querySelectorAll('.notification-card.unread').forEach(card => {
                        card.classList.remove('unread');
                        const button = card.querySelector('.btn-mark-read');
                        button.disabled = true;
                        button.textContent = 'Read';
                    });
                }
            })
            .catch(error => console.error('Error marking all as read:', error));
        });
        
        document.querySelectorAll('.filter-type').forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.filter-type').forEach(f => f.classList.remove('active'));
                this.classList.add('active');
                typeFilter = this.getAttribute('data-type');
                currentPage = 1;
                fetchNotifications();
            });
        });
        
        document.querySelectorAll('.filter-status').forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.filter-status').forEach(f => f.classList.remove('active'));
                this.classList.add('active');
                statusFilter = this.getAttribute('data-status');
                currentPage = 1;
                fetchNotifications();
            });
        });
        
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = this.value.trim();
                currentPage = 1;
                fetchNotifications();
            }, 500);
        });
        
        // Initial load
        fetchNotifications();
    });
</script>
{% endblock %}
